name: Build Android APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm install
      
    - name: Setup Expo CLI
      run: npm install -g @expo/cli
      
    - name: Setup EAS CLI
      run: npm install -g eas-cli
      
    - name: Configure EAS
      run: |
        echo "EXPO_TOKEN=${{ secrets.EXPO_TOKEN }}" >> .env
        eas build:configure --non-interactive
        
    - name: Build APK
      run: eas build --platform android --profile preview --non-interactive
      
    - name: Download APK
      run: |
        # APK 다운로드 URL을 가져옵니다
        BUILD_URL=$(eas build:list --platform android --limit 1 --json | jq -r '.[0].artifacts.buildUrl')
        curl -L -o app.apk "$BUILD_URL"
        
    - name: Upload APK to GitHub Releases
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ github.run_number }}
        release_name: DailyMind APK v${{ github.run_number }}
        body: |
          DailyMind Android APK
          
          ## 설치 방법
          1. APK 파일을 다운로드하세요
          2. 안드로이드 설정에서 "알 수 없는 소스" 허용
          3. APK 파일을 설치하세요
        draft: false
        prerelease: false
        files: app.apk
